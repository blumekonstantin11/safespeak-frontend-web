<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>SafeSpeak Server Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;

        }

        .container {
            width: 95%;
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode Styles */
        body.dark-mode { background-color: #2c3e50; color: #ecf0f1; }
        .dark-mode .container { background: #34495e; color: white; }
        .dark-mode h1, .dark-mode h2, .dark-mode h3 { color: #3498db; }
        .dark-mode form { background: #3a536b; }
        .dark-mode input, .dark-mode textarea { background: #4a637d; color: white; border: 1px solid #777; }
        .dark-mode #messages { background: #2c3e50; color: white; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #loggedInUsername { font-weight: bold; color: #3498db; cursor: pointer; }
        
        form { margin-bottom: 20px; padding: 15px; background: #ecf0f1; border-radius: 5px; }
        input, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background-color: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        
        .contact-button { display: block; width: 100%; text-align: left; margin: 5px 0; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; color: #333; }
        .contact-button:hover { background: #e8f4fd; }

        #messages { border: 1px solid #ddd; padding: 15px; background: #f9f9f9; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .status { font-style: italic; color: #555; background: #fff3cd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2 id="loggedInUsername" title="Klicken zum Abmelden"></h2>
            <img src="SafeSpeak.png" alt="Logo" id="theme-toggle-img" style="max-width: 50px; cursor: pointer;">
        </div>    
        
    <div id="auth-section">
        <h2>Anmelden</h2>
        <form id="loginForm">
            <input type="text" id="loginUsername" placeholder="Benutzername" required>
            <input type="password" id="loginPassword" placeholder="Passwort" required>
            <button type="submit">Anmelden</button>
        </form>

        <div id="terminal-status" style="background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; font-size: 0.8em; padding: 8px; border-radius: 4px; margin-top: 10px; min-height: 1.2em;">
            Bereit...
        </div>

        <hr style="margin: 20px 0;">

        <div id="reg-toggle-area">
            <p>Noch kein Konto?</p>
            <button onclick="toggleRegister()" style="background-color: #2ecc71; color: white; font-weight: bold; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Jetzt Registrieren</button>
        </div>

        <div id="register-container" style="display: none; margin-top: 20px;">
            <h2>Registrieren</h2>
            <form id="registerForm">
                <input type="text" id="regUsername" placeholder="Wunsch-Name" required>
                <input type="password" id="regPassword" placeholder="Passwort" required>
                <input type="text" id="regStreet" placeholder="Straße und Hausnummer" required>
                <input type="text" id="regZip" placeholder="PLZ" required>
                <input type="text" id="regCity" placeholder="Stadt" required>
                <div id="addressCheckStatus" style="font-size: 0.8em; margin-bottom: 10px;"></div>
                <button type="submit" id="regBtn" style="background-color: #2ecc71;">Konto erstellen</button>
            </form>
        </div>
    </div>

        <div id="suggestions-area" style="display: none;">
            <h3>Leute in deiner Nähe</h3>
            <div id="contact-list">Lade Kontakte...</div>
        </div>

        <div id="message-section" style="display: none;">
            <hr>
            <h2>Chat mit <span id="activePartner">...</span></h2>
            <div id="messages"></div>
            <form id="messageForm" style="margin-top:10px;">
                <textarea id="messageContent" placeholder="Deine Nachricht..." required></textarea>
                <button type="submit">Senden</button>
            </form>

        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const API_URL = "https://safespeak-api-server.onrender.com";
        const socket = io("https://safespeak-api-server.onrender.com", {
        transports: ["websocket"] // Wichtig für Render, da Polling oft Probleme macht
    });

        let isDarkMode = localStorage.getItem('safespeakTheme') === 'dark';

        // --- THEME ---
        function applyTheme(dark) {
            isDarkMode = dark;
            document.body.classList.toggle('dark-mode', dark);
            localStorage.setItem('safespeakTheme', dark ? 'dark' : 'light');
        }

        document.getElementById('theme-toggle-img').onclick = () => applyTheme(!isDarkMode);


        function applyLoggedInUI(username) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('suggestions-area').style.display = 'block';
            document.getElementById('message-section').style.display = 'block';
            document.getElementById('loggedInUsername').textContent = `Hi, ${username}!`;
    
            // DEM SERVER SAGEN, WER ICH BIN (WICHTIG!)
            socket.emit('join', username); 
    
            loadContacts();
        }


        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const terminal = document.getElementById('terminal-status');
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            terminal.textContent = "> Verbinde mit SafeSpeak-Core...";

            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
    
            const data = await res.json();
    
            if (data.token) {
                terminal.textContent = "> Zugriff gewährt. Initialisiere Session...";
                localStorage.setItem('safespeakToken', data.token);
                localStorage.setItem('safespeakUsername', username);
                setTimeout(() => applyLoggedInUI(username), 500);
            } else {
                terminal.textContent = "> FEHLER: " + (data.error || "Login fehlgeschlagen");
                terminal.style.color = "#ff4444";
                setTimeout(() => { terminal.style.color = "#00ff00"; }, 2000);
            }
        };


        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const statusDiv = document.getElementById('addressCheckStatus');
            const regBtn = document.getElementById('regBtn');
    
            const street = document.getElementById('regStreet').value;
            const zip = document.getElementById('regZip').value;
            const city = document.getElementById('regCity').value;

            statusDiv.textContent = "Prüfe Adresse...";
            statusDiv.style.color = "orange";
            regBtn.disabled = true;

            // 1. ADRESS-PRÜFUNG via OpenStreetMap (Nominatim)
            try {
                const checkRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&street=${encodeURIComponent(street)}&postalcode=${encodeURIComponent(zip)}&city=${encodeURIComponent(city)}&country=Germany`);
                const checkData = await checkRes.json();

                if (checkData.length === 0) {
                    statusDiv.textContent = "Fehler: Diese Adresse wurde nicht gefunden!";
                    statusDiv.style.color = "red";
                    regBtn.disabled = false;
                    return;
                }

                statusDiv.textContent = "Adresse verifiziert!";
                statusDiv.style.color = "green";
            } catch (err) {
                console.error("Adress-Check Fehler", err);
            // Falls die API down ist, lassen wir die Registrierung zur Sicherheit trotzdem zu
            }

            // 2. EIGENTLICHE REGISTRIERUNG
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;

            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, street, zip, city })
            });
    
            const data = await res.json();
            if (data.userId) {
                alert("Erfolgreich registriert!");
                location.reload();
            } else {
                alert("Fehler: " + data.error);
                regBtn.disabled = false;
            }
        };

        function toggleRegister() {
            const container = document.getElementById('register-container');
            const toggleArea = document.getElementById('reg-toggle-area');
    
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleArea.style.display = 'none'; // Versteckt den "Jetzt Registrieren" Button
            }
        }

            // --- NACHRICHTEN LADEN (Neu hinzugefügt) ---
            async function fetchMessages(partnerName) {
                const token = localStorage.getItem('safespeakToken');
                const res = await fetch(`${API_URL}/messages?withUser=${partnerName}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const messages = await res.json();
                const container = document.getElementById('messages');
                container.innerHTML = '';
    
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = "5px";
                    div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.content}`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            }

            // --- NACHRICHT SENDEN ---
            document.getElementById('messageForm').onsubmit = async (e) => {
                e.preventDefault();
                const content = document.getElementById('messageContent').value;
                const receiver = document.getElementById('activePartner').textContent;
                const token = localStorage.getItem('safespeakToken');

                if (receiver === "...") {
                    alert("Bitte wähle zuerst einen Kontakt aus!");
                    return;
                }

                // Nachricht via Socket senden (für Echtzeit)
                socket.emit('private_message', {
                    to: receiver,
                    content: content,
                    token: token
                });

                // Feld leeren
                document.getElementById('messageContent').value = '';
    
                // Nachricht lokal sofort anzeigen
                const container = document.getElementById('messages');
                const div = document.createElement('div');
                div.innerHTML = `<strong>Ich:</strong> ${content}`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            };

            // --- ECHTZEIT-EMPFANG ---
            socket.on('new_message', (msg) => {
                const activePartner = document.getElementById('activePartner').textContent;
                // Nur anzeigen, wenn wir gerade mit dieser Person chatten
                if (msg.sender === activePartner) {
                    const container = document.getElementById('messages');
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.content}`;
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                } else {
                    alert("Neue Nachricht von " + msg.sender);
                }
            });

            // --- KONTAKTE (Update der Klick-Funktion) ---
            async function loadContacts() {
                const token = localStorage.getItem('safespeakToken');
                const list = document.getElementById('contact-list');
                try {
                    const res = await fetch(`${API_URL}/contacts`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const contacts = await res.json();
                    list.innerHTML = '';
                    contacts.forEach(user => {
                        const btn = document.createElement('button');
                        btn.className = 'contact-button';
                        btn.textContent = `${user.username} (PLZ: ${user.location})`;
                        btn.onclick = () => {
                            document.getElementById('activePartner').textContent = user.username;
                            fetchMessages(user.username); // <--- Jetzt aktiv!
                        };
                        list.appendChild(btn);
                    });
                } catch (err) {
                    list.innerHTML = 'Fehler beim Laden der Kontakte.';
                }
            }

        socket.on('new_message', (msg) => {
            const activePartner = document.getElementById('activePartner').textContent;
            if (msg.sender === activePartner) {
                const container = document.getElementById('messages');
                const div = document.createElement('div');
                div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.content}`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            } else {
                alert("Neue Nachricht von " + msg.sender);
            }
        });

        // --- LOGOUT ---
        document.getElementById('loggedInUsername').onclick = () => {
            localStorage.clear();
            location.reload();
        };

        // --- START ---
        window.onload = () => {
            applyTheme(isDarkMode);
            const savedUser = localStorage.getItem('safespeakUsername');
            if (savedUser) applyLoggedInUI(savedUser);
        };
    </script>
</body>
</html>
